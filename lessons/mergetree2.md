## Движок MergeTree

### Основные особенности
- Данные записываются по частям, маленькими кусочками (parts)
- Данные объединяются в фоновом режиме (процесс Merge)
- Хранит данные, отсортированные по первичному ключу (или ключу сортировки)
- Используется разреженный индекс, который не обеспечивает уникальности
- Поддерживает репликацию данных (с помощью ReplicatedMergeTree)
- Поддерживает сэмплирование данных
- Используется сжатие данных

### Синтаксис CREATE TABLE
```sql
CREATE TABLE [IF NOT EXISTS] [db.]table_name [ON CLUSTER cluster] (
  name1 [type1] [DEFAULT|MATERIALIZED|ALIAS expr1] [TTL expr1],
  name2 [type2] [DEFAULT|MATERIALIZED|ALIAS expr2] [TTL expr2],
  ...
  INDEX index_name1 expr1 TYPE type1(...) GRANULARITY value1,
  INDEX index_name2 expr2 TYPE type2(...) GRANULARITY value2
) ENGINE = MergeTree()
ORDER BY expr
[PARTITION BY expr]
[PRIMARY KEY expr]
[SAMPLE BY expr]
[TTL expr
  [DELETE|TO DISK 'xxx'|TO VOLUME 'xxx' [, ...] ]
  [WHERE conditions]
  [GROUP BY key_expr [SET v1 = aggr_func(v1) [, v2 = aggr_func(v2) ...]] ] ]
[SETTINGS name=value, ...]
```

### Атрибуты таблицы
- **ORDER BY** — ключ сортировки (обязательный)
- **PARTITION BY** — ключ партицирования (например, `toYYYYMM(date_column)`)
- **PRIMARY KEY** — первичный ключ (если отличается от ключа сортировки)
- **SAMPLE BY** — выражение для сэмплирования
- **TTL** — правила хранения, удаления или перемещения данных
- **SETTINGS** — настройки таблицы (гранулярность, политика хранения и др.)

### Атрибуты полей
- **MATERIALIZED** — вычисляемое и сохраняемое значение
- **ALIAS** — вычисляемое выражение, не сохраняется
- Можно указать кодек сжатия данных
- **TTL колонки** — определяет, когда значения сбрасываются в дефолтное состояние (нельзя применять к полям из ключа сортировки)

### Пример создания таблицы
```sql
DROP TABLE IF EXISTS otus_tbl;
CREATE TABLE otus_tbl (
  id UInt64,
  name String
) ENGINE MergeTree()
ORDER BY id;
```

### Хранение данных на диске. Куски (parts)
- Кусок (part) — директория с файлами, создаваемая при каждом INSERT
  - Формат имени: `partitionId_minBlock_maxBlock_mergeLevel_<mutation>`
- Куски объединяются слияниями (merges) в фоновом режиме или принудительно (`OPTIMIZE TABLE`)
- Форматы хранения файлов внутри куска:
  - **wide** — каждый столбец в отдельном файле
  - **compact** — все столбцы в одном файле
  - Регулируется параметрами `min_rows_for_wide_part` и `min_bytes_for_wide_part`

### Партиции
- Определяются произвольным ключом партицирования
- Не рекомендуется делать слишком гранулированными
- Оптимизируют работу с данными
- Директория `detached` содержит куски, отсоединённые от таблицы (например, после `DETACH`)

### Ключ сортировки и первичный ключ
- **Ключ сортировки** — обязательный параметр
- **Первичный ключ**:
  - Может не указываться (по умолчанию равен ключу сортировки)
  - Если указан, должен быть префиксом ключа сортировки
  - Не обеспечивает уникальность
  - Позволяет поиск по любой части ключа
  - Используется разреженный индекс (файл `primary.cidx`)

### Слияние (Merge)
- Процесс запускается в фоновом режиме для оптимизации хранения
- Один кусок участвует только в одном слиянии
- Куски из разных партиций не сливаются вместе
- Обработанные куски становятся неактивными и позже удаляются
- Чтение происходит только из активных кусков

### Внеплановое слияние (`OPTIMIZE TABLE`)
```sql
OPTIMIZE TABLE [PARTITION partition | PARTITION ID 'partition_id']
[FINAL]
[DEDUPLICATE [BY expression]]
SETTINGS [
  alter_sync = [0, 1, 2],
  optimize_throw_if_noop = [0, 1]
]
```

---

## Другие движки семейства MergeTree

### 1. SummingMergeTree
- Группирует данные по первичному ключу
- Суммирует значения в указанных полях
- Остальные поля агрегируются выбором произвольного значения
- Группировка происходит во время слияний

### 2. AggregatingMergeTree
- Группирует данные по первичному ключу
- Использует типы `AggregateFunction` и `SimpleAggregateFunction`
- Для вставки используются `-State`-функции, для выборки — `-Merge`-функции
- Подходит для инкрементальной агрегации

### 3. ReplacingMergeTree
- Удаляет дублирующиеся записи с одинаковым ключом сортировки
- Остаётся самая последняя строка (или с наибольшей версией, если указана)
- Удаление происходит при слиянии
- Не гарантирует отсутствие дубликатов без `FINAL`

### 4. CollapsingMergeTree
- Подходит для частых обновлений
- Использует столбец `sign` (1 — добавление, -1 — удаление)
- Удаляет пары строк с одинаковым ключом и разными знаками при слиянии

### 5. VersionedCollapsingMergeTree
- Расширение `CollapsingMergeTree` с поддержкой версионирования
- Позволяет работать с многопоточной вставкой
- Удаляет пары строк с одинаковым ключом, версией и разными знаками

### 6. GraphiteMergeTree
- Предназначен для хранения и агрегации данных Graphite
- Настройка прореживания (rollup) через конфигурацию
- Обязательные столбцы: `Path`, `Time`, `Value`, `Timestamp` (или кастомные)

---

## Контрольные вопросы
1. Что такое кусок?
2. Уникальны ли значения в первичном ключе?
3. Чем отличается первичный ключ от ключа сортировки?

---
