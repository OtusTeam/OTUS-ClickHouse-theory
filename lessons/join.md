## JOIN в ClickHouse

### Базовые соединения
- **INNER JOIN** – возвращает данные, совпадающие по ключам соединения. При нескольких совпадениях возвращает все (декартово произведение).
- **LEFT OUTER JOIN** – возвращает данные из левой таблицы и совпадающие по ключам. При отсутствии совпадений поля правой таблицы содержат NULL.
- **RIGHT OUTER JOIN** – возвращает данные из правой таблицы и совпадающие по ключам. При отсутствии совпадений поля левой таблицы содержат NULL.
- **FULL OUTER JOIN** – объединяет LEFT и RIGHT OUTER JOIN. Возвращает данные из обеих таблиц, отсутствующие поля заполняются NULL.
- **CROSS JOIN** – создаёт полное декартово произведение двух таблиц без учёта ключей.

### Специальные соединения
- **LEFT SEMI JOIN / RIGHT SEMI JOIN** – возвращает значения для строк главной таблицы, имеющих хотя бы одно совпадение в другой таблице. Возвращается только первое совпадение.
- **LEFT ANTI JOIN / RIGHT ANTI JOIN** – возвращает значения для несовпадающих строк из левой (или правой) таблицы.
- **LEFT ANY JOIN / RIGHT ANY JOIN / INNER ANY JOIN** – работают как соответствующие OUTER/INNER JOIN, но без декартова произведения.
- **ASOF JOIN** – позволяет неточное сопоставление: при отсутствии точного соответствия используется ближайшее значение. Декартово произведение отсутствует.
- **PASTE JOIN** – возвращает таблицу со всеми столбцами из левого подзапроса, затем из правого. Строки сопоставляются по позициям. Лишние строки обрезаются.

### Проблемы JOIN в ClickHouse
- Столбцовая структура хранения данных.
- Распределённая природа – накладные расходы на сетевую связь.
- Отсутствие традиционных индексов (B-tree, bitmap).
- Неэффективное использование памяти.
- Ограниченные типы соединений.
- Менее совершенный планировщик запросов.

### Рекомендации по оптимизации
- Денормализация, избыточность.
- Материализованные представления.
- Выбор алгоритма объединения.
- Оптимизация структуры таблиц.
- Использование распределённых таблиц.
- Использование массивов и вложенных данных.

### Настройки JOIN
- `join_default_strictness`
- `any_join_distinct_right_table_keys`
- `join_algorithm`
- `join_any_take_last_row`
- `join_use_nulls`
- `partial_merge_join_optimizations`
- `partial_merge_join_rows_in_right_blocks`
- `join_on_disk_max_files_to_merge`

---

## Агрегатные функции

### Определение
Агрегатная функция вычисляет единственное значение, обрабатывая множество строк.

### Типы агрегатных функций
- **Стандартные**: `count`, `min`, `max`, `sum`, `avg`, `any`, `stddevPop`, `stddevSamp`, `varPop`, `varSamp`, `corr`.
- **Специальные**: `anyHeavy`, `deltaSum`, `deltaSumTimestamp`, `groupArray`, `boundingRatio`, `groupArrayLast`, `groupUniqArray`, `last_value`, `groupArrayInsertAt`, `argMin`, `groupArrayMovingAvg`, `argMax`, `groupArrayMovingSum`, `avgWeighted`, `topK`, `topKWeighted`.

### Основные функции
- **COUNT** – считает количество строк. `COUNT(*)` считает все строки, включая дубликаты и NULL.
- **SUM** – вычисляет сумму числовых столбцов. Игнорирует NULL.
- **MAX / MIN** – находят максимальное/минимальное значение. Игнорируют NULL.
- **AVG** – вычисляет среднее значение.
- **ANY** – выбирает первое попавшееся значение (недетерминировано).
- **ARGMAX / ARGMIN** – возвращают значение аргумента при максимальном/минимальном значении.
- **GROUPARRAY** – собирает все значения в массив.
- **GROUPUNIQARRAY** – собирает уникальные значения в массив.

### Оператор GROUP BY
Используется для группировки строк, часто в комбинации с агрегатными функциями.

---
